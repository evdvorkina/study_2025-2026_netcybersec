---
## Author
author:
    - Александрова У.В.,
    - Волгин И.А,
    - Голощапов Я.В.,
    - Дворкина Е.В.,
    - Серегина И.А.

## Title
title: "Отчет по лабораторной работе №2-A «ЗАЩИТА КОНТРОЛЛЕРА ДОМЕНА ПРЕДПРИЯТИЯ»"
subtitle: "Кибербезопасность предприятия"
license: "CC BY"
---

# Цель работы

Целью данной лабораторной работы является освоение практических навыков выявления, анализа и устранения уязвимостей информационных систем в рамках сценария «Защита контроллера домена предприятия».


# Задание

- Обнаружить, проанализировать и закрыть уязвимости:

  1. SQL-инъекция;

  2. Отключенная защита антивируса;

  3. Слабый пароль учетной записи.

- Определить и устранить последствия эксплуатации уязвимостей:

  1. Web portal meterpreter (последствие уязвимости 1);
  2. Admin meterpreter (последствие уязвимости 2);
  3. Добавление привилегированного пользователя (последствие уязвимости 3).

- Разработать и применить меры по устранению выявленных уязвимостей.


# Теоретическое введение

SQL-инъекция - это уязвимость веб-приложений, возникающая из-за недостаточной проверки пользовательского ввода, которая позволяет злоумышленнику внедрять и выполнять произвольные SQL-команды в базе данных приложения [@sql].

Отключенная защита антивируса - это состояние системы, при котором антивирусное программное обеспечение намеренно или случайно деактивировано, что делает систему уязвимой для вредоносных программ и кибератак без обнаружения и блокировки угроз.

Слабый пароль учетной записи - это использование ненадежных, легко угадываемых или коротких паролей, которые могут быть быстро подобраны злоумышленником с помощью автоматизированных атак перебора или словарных атак.

Web portal meterpreter - это последствие успешной эксплуатации уязвимости, при котором злоумышленник получает несанкционированный доступ к веб-серверу и устанавливает Meterpreter payload для удаленного управления compromised системой [@meter].

Admin meterpreter - это получение полных привилегий администратора в системе с установлением скрытого удаленного доступа через Meterpreter сессию, что позволяет злоумышленнику выполнять любые действия от имени администратора [@meter].

Добавление привилегированного пользователя - это техника сохранения доступа, при которой злоумышленник создает новую учетную запись с расширенными правами в системе для обеспечения постоянного несанкционированного доступа даже после закрытия первоначальной уязвимости.

# Выполнение лабораторной работы

## Описание сценария

Последовательность действий нарушителя следующая:

1. Нарушитель проводит сканирование сети 195.239.174.0/24 и находит веб-сервер. Далее сканирует веб-сервер на предмет SQL-инъекций утилитой sqlmap. Нарушитель генерирует php reverse shell, используя найденную SQL-инъекцию, загружает вредоносный файл на веб-сервер. Для закрепления на хосте нарушитель устанавливает meterpreter-соединение.
2. Нарушитель определяет маршрут к сети 10.10.2.0/24, сканирует сеть и находит почтовый сервер. Нарушитель генерирует письмо с вредоносным вложением и отправляет  администратору.
3. Администратор открывает письмо, запускается вредоносный скрипт.
4. Нарушитель получает контроль над компьютером администратора и meterpreter-сессию.
5. Нарушитель находит AD&DNS сервер, проверяет, открыт ли порт 3389 (стандартный порт RDP). В случае открытого порта 3389 пытается с помощью инструмента hydra получить доступ к AD&DNS серверу, перебирая пароль по словарю. Для закрепления на контроллере домена нарушитель добавляет нового привилегированного пользователя.

## Обнаружение уязвимостей

Уязвимости и последствия будут детектироваться в основном с помощью ViPNet IDS NS, некоторые последствия обнаруживаем с помощью работы на сервере или с помощью дополнительных приложений, далее последствия и уязвимости будут записываться в карточки инцидентов [@lab].

Для обнаружения актуальной подозрительной активности пользуемся фильтрами по дате, времени и важности.

### Обнаружение уязвимости "SQL-инъекция"

Сетевой сенсор ViPNet IDS NS детектирует события сканирования веб-сервера на предмет SQL-инъекций (множественное срабатывание правила ET SCAN ... указывает на неоднократные сканирования, правила ET SCAN sqlmap говорят о сканировании с помощью утилиты sqlmap, которая отслеживает SQL-инъекции) ([рис. @fig-001]), ([рис. @fig-002]).

![Сканирование на предмет SQL-инъекций](image/1.PNG){#fig-001 width=70%}

![Сканирование на предмет SQL-инъекций](image/2.PNG){#fig-002 width=70%}

Видим использование определенного типа инъекции (Blind SQL-Injection) ([рис. @fig-003]), а также загрузку вредоносного файла с php скриптом, что может указывать на использование php reverse shell и выставление права доступа на выполнение ([рис. @fig-005]).

![Детектирование SQL-инъекции](image/3.PNG){#fig-003 width=70%}

![Загрузка вредоносного файла и выставление права доступа на выполнение](image/5.PNG){#fig-005 width=70%}

Также видим пакет к событию, в котором указан некий файл php и действие загрузки - upload ([рис. @fig-004]).

![Пакет к событию](image/4.PNG){#fig-004 width=70%}

Заполним карточку инцидента ([рис. @fig-006]).

![Карточка инцидента](image/6.PNG){#fig-006 width=70%}

Все это соответствует первому пункту сценария.

### Обнаружение и устранение последствия Web portal meterpreter.

Нарушитель устанавливает shell сессию с веб-порталом PHP. Для обнаружения этого проверим сокеты уязвимой машины (Web Server PHP) при помощи утилиты ss с ключами –tp (утилита указывает, между какими компьютерами в сети установлена связь) ([рис. @fig-007]). Увидим подозрительное соединение с внешним сервером.

![Список установленных соединений](image/66.png){#fig-007 width=70%}

Заполним карточку инцидента ([рис. @fig-008]).

![Карточка инцидента](image/9.PNG){#fig-008 width=70%}

### Обнаружение уязвимости "Отключенная защита антивируса"

Один из способов проверки состояния защиты в реальном времени Windows Defender – в Powershell ввести команду Get-MpPreference и проверить значение параметра DisableRealtimeMonitoring. Если значение – True, то защита в реальном времени выключена ([рис. @fig-010]). Мы ввели эту команду на узле администратора 10.10.4.10 и действительно получили, что отключение мониторинга с параметром True, значит, защита антивируса отключена.

![Настройки Windows Defender](image/10.png){#fig-010 width=70%}

Заполним карточку инцидента ([рис. @fig-011]).

![Карточка инцидента](image/11.PNG){#fig-011 width=70%}

### Обнаружение последствия "Admin meterpreter"

Установленную сессию с нарушителем обнаружили при помощи утилиты netstat с ключами –ano ([рис. @fig-027]).

![Соединение с машиной нарушителя](image/27.png){#fig-027 width=70%}

Заполняем карточку инцидента ([рис. @fig-035]).

![Карточка инцидента](image/35.png){#fig-035 width=70%}

### Обнаружение уязвимости "Слабый пароль учетной записи"

С помощью ViPNet IDS NS в сетевом трафике обнаруживаются множественные попытки подключения к хосту AD&DNS с портом 3389 ([рис. @fig-013]), сканирование системы, что может говорить о попытках подбора пароля([рис. @fig-015]). Также если мы зайдем на сам узел Active Directory, откроем Viewer Properties, перейдем в необходимую директорию с событиями (TerminalServeces...), то сможем увидеть событие с кодо 1149, которое говорит о том, что пользователю удалось подключиться по RDP.

![RDP Bruteforce](image/13.PNG){#fig-013 width=70%}

![RDP Bruteforce](image/15.PNG){#fig-015 width=70%}

Заполняем карточку инцидента ([рис. @fig-016]).

![Карточка инцидента](image/16.PNG){#fig-016 width=70%}

Эти действия нарушителя соответствуют пункту 5 сценария.

### Обнаружение последствия "AD User"

Добавление нового привилегированного пользователя отследили с помощью аудита событий входа в учетную запись Windows security (Viewer Properties). Далее перешли в Event Viewer и в Windows Logs – Security, затем применили фильтр на логи. Событие с ID 4720 должно было в нашей лабораторной появиться во временном промежутке с 17:30 до 18:00 ([рис. @fig-017]). Альтернативный способ обнаружения этого последствия - непосредственно зайти в Active Directory Users and Computers, где мы увидим странного нового пользователя ([рис. @fig-018]), ([рис. @fig-019]).

![Переход в отслеживание событий](image/17.PNG){#fig-017 width=70%}

![Нахождение hacker в AD User & Computers](image/18.PNG){#fig-018 width=70%}

![Попытка нахождения события hacker в AD User & Computers](image/19.PNG){#fig-019 width=70%}

Заполняем карточку инцидента ([рис. @fig-020])

![Карточка инцидента](image/20.PNG){#fig-020 width=70%}

## Устранение уязвимостей и их последствий

### Устранение уязвимости "SQL-инъекция"

SQL-инъекция, то есть эксплуатируемая уязвимость, как было известно из анализа событий, находится на узле Web Server PHP (10.10.1.20). Переходим на него с помощью SSH подключения.
Известно, что $id является уязвимым параметром, следует проверять тип данного параметра. Требуется найти место кода, где данный параметр считывается из GET запроса ([рис. @fig-024]).

![Поиск места уязвимого параметра](image/24.png){#fig-024 width=70%}

Для проверки типа $id используется функция is_numeric, которая возвращает True в случае, если $id – число, иначе – False. В случае успешной проверки параметр $id будет передаваться в запрос, иначе – запрос будет статичным и независимым от $id ([рис. @fig-025]).

![Измененная функция actionView с проверкой типа параметра $id](image/25.png){#fig-025 width=70%}

После внесения изменений в файл конфигурации и проверки значения параметра $id уязвимость SQL-инъекции успешно устранена.

### Устранение последствия Web portal meterpreter.

Нарушитель установил shell сессию с веб-порталом PHP. Ранее мы проверили сокеты уязвимой машины (Web Server PHP) и нашли соединение с внешним подозрительным сервером: активное соединение веб-портала с IP-адресом нарушителя (195.239.174.11). Для устранения необходимо воспользоваться командой ssс правами привилегированного пользователя, используя ключ –K и соответствующий адрес, порт для завершения сессии с нарушителем: sudo ss -K dst HACKER_IP dport = HACKER_PORT ([рис. @fig-026]).

![Завершение сессии с нарушителем](image/26.png){#fig-026 width=70%}

В результате выполнения команды сессия с нарушителем завершена, последствие Web portal meterpreter успешно устранено.

### Устранение уязвимости "Отключенная защита антивируса"

На узле Administrator Workstation мы удалили запись об отключенном антишпионском ПО в реестре через консоль, используя команду ([рис. @fig-029]): `REG DELETE "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware`. Подтвердили действие, далее в Windows Defender перезапустили Virus & Threat Protection ([рис. @fig-030]) и включили Real-time Protection ([рис. @fig-031])

![Удаление записи DisableAntiSpyware в реестре](image/29.png){#fig-029 width=70%}

![Интерфейс Windows Defender](image/30.png){#fig-030 width=70%}

![Включение Real-time Protection](image/31.png){#fig-031 width=70%}

После удаления записи реестра и включения защиты антивирусной программы Microsoft Defender перезагрузили Windows.

### Устранения последствия "Admin meterpreter"

Установленную сессию с нарушителем ранее обнаружили при помощи утилиты netstat с ключами –ano ([рис. @fig-027]).

![Соединение с машиной нарушителя](image/27.png){#fig-027 width=70%}

Для устранения завершили сессию с машиной нарушителя при помощи команды taskkill /f /pid <PID> ([рис. @fig-028]).

![Остановка процесса](image/28.png){#fig-028 width=70%}

В результате выполнения команды сессия с машиной нарушителя завершена, последствие Admin meterpreter успешно устранено.

### Устранение уязвимости "Слабый пароль учетной записи"

Изменяем пароль к учетной записи администратора на более сложный, не содержащийся в словарях ([рис. @fig-033]), на узле MS Active Directory.

![Изменение пароля администратора](image/33.png){#fig-033 width=70%}

На вышеупомянутом рисунке изображена смена пароля администратора на узле MS Active Directory командой «net user Administrator *». В результате изменения ненадежного пароля уязвимость успешно устранена.

### Обнаружение и устранение последствия "AD User"

Для удаления пользователя зашли в Administrative Tools – Active Directory Users and computers. Затем во вкладке Users найшли и удалилинового привилегированного пользователя с именем «Hacked» ([рис. @fig-034]).

![Удаление пользователя hacker в AD User & Computers](image/34.png){#fig-034 width=70%}

# Выводы

В ходе выполнения лабораторной работы были успешно достигнуты поставленные цели: освоены практические навыки выявления, анализа и устранения типовых уязвимостей информационной системы. В рамках сценария «Защита контроллера домена предприятия» были обнаружены и закрыты критические уязвимости и их последствия эксплуатации ([рис. @fig-022]) ([рис. @fig-023]).

![Выполненные карточки](image/22.PNG){#fig-022 width=70%}

![Закрытые уязвимости и последствия](image/23.PNG){#fig-023 width=70%}

# Список литературы{.unnumbered}

::: {#refs}
:::
