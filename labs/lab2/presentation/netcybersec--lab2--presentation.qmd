---
## Author
author:
    - Александрова У.В.,
    - Волгин И.А,
    - Голощапов Я.В.,
    - Дворкина Е.В.,
    - Серегина И.А.
## Title
title: Лабораторная работа№2-A «ЗАЩИТА КОНТРОЛЛЕРА ДОМЕНА ПРЕДПРИЯТИЯ»
subtitle: "Кибербезопасность предприятия"
license: CC BY
date: today
date-format: "YYYY-MM-DD" # Example: 2025-10-15
---

## Cостав команды

Александрова Ульяна Вадимовна

Волгин Иван Алексеевич

Голощапов Ярослав Вячеславович

Дворкина Ева Владимировна

Серёгина Ирина Андреевна


## Цели и задачи

Целью данной лабораторной работы является освоение практических навыков выявления, анализа и устранения уязвимостей информационных систем в рамках сценария «Защита контроллера домена предприятия».

Обнаружить, проанализировать и закрыть уязвимости:

- SQL-инъекция;

- защита антивируса;

 - Слабый пароль учетной записи.

Определить и устранить последствия эксплуатации уязвимостей:

- Web portal meterpreter (последствие уязвимости 1);
- Admin meterpreter (последствие уязвимости 2);
- Добавление привилегированного пользователя (последствие уязвимости 3).

Разработать и применить меры по устранению выявленных уязвимостей.

# Выполнение лабораторной работы

## Обнаружение уязвимостей

Уязвимости и последствия будут детектироваться в основном с помощью ViPNet IDS NS, некоторые последствия обнаруживаем с помощью работы на сервере или с помощью дополнительных приложений, далее последствия и уязвимости будут записываться в карточки инцидентов.

Для обнаружения актуальной подозрительной активности пользуемся фильтрами по дате, времени и важности.

## Обнаружение уязвимости "SQL-инъекция"

Сетевой сенсор ViPNet IDS NS детектирует события сканирования веб-сервера на предмет SQL-инъекций (множественное срабатывание правила ET SCAN ... указывает на неоднократные сканирования, правила ET SCAN sqlmap говорят о сканировании с помощью утилиты sqlmap, которая отслеживает SQL-инъекции)

:::::::::::::: {.columns align=center}
::: {.column width="45%"}

![Сканирование на предмет SQL-инъекций](image/1.PNG){#fig-001 width=70%}

:::
::: {.column width="45%"}

![Сканирование на предмет SQL-инъекций](image/2.PNG){#fig-002 width=70%}

:::
::::::::::::::

## Обнаружение уязвимости "SQL-инъекция"

Видим использование определенного типа инъекции (Blind SQL-Injection), а также загрузку вредоносного файла с php скриптом, что может указывать на использование php reverse shell и выставление права доступа на выполнение.

:::::::::::::: {.columns align=center}
::: {.column width="45%"}

![Детектирование SQL-инъекции](image/3.PNG){#fig-003 width=70%}

:::
::: {.column width="45%"}

![Загрузка вредоносного файла и выставление права доступа на выполнение](image/5.PNG){#fig-004 width=70%}

:::
::::::::::::::

## Обнаружение уязвимости "SQL-инъекция"

Также видим пакет к событию, в котором указан некий файл php и действие загрузки - upload.

![Пакет к событию](image/4.PNG){#fig-005 width=70%}


## Карточка инцидента

:::::::::::::: {.columns align=center}
::: {.column width="29%"}

Заполним карточку инцидента.

:::
::: {.column width="69%"}

![Карточка инцидента](image/6.PNG){#fig-006 width=70%}

:::
::::::::::::::


## Обнаружение и устранение последствия Web portal meterpreter.

Нарушитель устанавливает shell сессию с веб-порталом PHP. Для обнаружения этого проверим сокеты уязвимой машины (Web Server PHP) при помощи утилиты ss с ключами –tp (утилита указывает, между какими компьютерами в сети установлена связь). Увидим подозрительное соединение с внешним сервером.

![Список установленных соединений](image/66.png){#fig-007 width=70%}

## Карточка инцидента

:::::::::::::: {.columns align=center}
::: {.column width="29%"}

Заполним карточку инцидента.

:::
::: {.column width="69%"}

![Карточка инцидента](image/9.PNG){#fig-008 width=70%}

:::
::::::::::::::


## Обнаружение уязвимости "Отключенная защита антивируса"

:::::::::::::: {.columns align=center}
::: {.column width="49%"}

![Настройки Windows Defender](image/10.png){#fig-009 width=85%}

:::
::: {.column width="49%"}

Один из способов проверки состояния защиты в реальном времени Windows Defender – в Powershell ввести команду Get-MpPreference и проверить значение параметра DisableRealtimeMonitoring. Если значение – True, то защита в реальном времени выключена. Мы ввели эту команду на узле администратора 10.10.4.10 и действительно получили, что отключение мониторинга с параметром True, значит, защита антивируса отключена.

:::
::::::::::::::

## Карточка инцидента

Заполним карточку инцидента.

![Карточка инцидента](image/11.PNG){#fig-010 width=70%}

## Обнаружение последствия "Admin meterpreter"

:::::::::::::: {.columns align=center}
::: {.column width="29%"}

Установленную сессию с нарушителем обнаружили при помощи утилиты netstat с ключами –ano.

:::
::: {.column width="69%"}


![Соединение с машиной нарушителя](image/27.png){#fig-011 width=70%}

:::
::::::::::::::


## Карточка инцидента

:::::::::::::: {.columns align=center}
::: {.column width="69%"}

![Карточка инцидента](image/35.png){#fig-012 width=75%}

:::
::: {.column width="29%"}

Заполняем карточку инцидента.

:::
::::::::::::::

## Обнаружение уязвимости "Слабый пароль учетной записи"

С помощью ViPNet IDS NS в сетевом трафике обнаруживаются множественные попытки подключения к хосту AD&DNS с портом 3389 , сканирование системы, что может говорить о попытках подбора пароля. Также если мы зайдем на сам узел Active Directory, откроем Viewer Properties, перейдем в необходимую директорию с событиями (TerminalServeces...), то сможем увидеть событие с кодо 1149, которое говорит о том, что пользователю удалось подключиться по RDP.

:::::::::::::: {.columns align=center}
::: {.column width="45%"}

![RDP Bruteforce](image/13.PNG){#fig-013 width=70%}

:::
::: {.column width="45%"}

![RDP Bruteforce](image/15.PNG){#fig-014 width=70%}

:::
::::::::::::::


## Карточка инцидента

:::::::::::::: {.columns align=center}
::: {.column width="29%"}

Заполняем карточку инцидента

:::
::: {.column width="69%"}

![Карточка инцидента](image/16.PNG){#fig-015 width=90%}

:::
::::::::::::::

## Обнаружение последствия "AD User"

:::::::::::::: {.columns align=center}
::: {.column width="39%"}

![Переход в отслеживание событий](image/17.PNG){#fig-016 width=90%}

:::
::: {.column width="59%"}

Добавление нового привилегированного пользователя отследили с помощью аудита событий входа в учетную запись Windows security (Viewer Properties). Далее перешли в Event Viewer и в Windows Logs – Security, затем применили фильтр на логи. Событие с ID 4720 должно было в нашей лабораторной появиться во временном промежутке с 17:30 до 18:00. Альтернативный способ обнаружения этого последствия - непосредственно зайти в Active Directory Users and Computers, где мы увидим странного нового пользователя.

:::
::::::::::::::

## Обнаружение последствия "AD User"

:::::::::::::: {.columns align=center}
::: {.column width="45%"}

![Нахождение hacker в AD User & Computers](image/18.PNG){#fig-017 width=70%}

:::
::: {.column width="45%"}

![Попытка нахождения события hacker в AD User & Computers](image/19.PNG){#fig-018 width=70%}

:::
::::::::::::::

## Карточка инцидента

:::::::::::::: {.columns align=center}
::: {.column width="29%"}

Заполняем карточку инцидента

:::
::: {.column width="69%"}

![Карточка инцидента](image/20.PNG){#fig-019 width=70%}

:::
::::::::::::::

## Устранение уязвимости "SQL-инъекция"

:::::::::::::: {.columns align=center}
::: {.column width="49%"}

![Поиск места уязвимого параметра](image/24.png){#fig-020 width=70%}

:::
::: {.column width="49%"}

SQL-инъекция, то есть эксплуатируемая уязвимость, как было известно из анализа событий, находится на узле Web Server PHP (10.10.1.20). Переходим на него с помощью SSH подключения.
Известно, что $id является уязвимым параметром, следует проверять тип данного параметра. Требуется найти место кода, где данный параметр считывается из GET запроса.

:::
::::::::::::::

## Устранение уязвимости "SQL-инъекция"

Для проверки типа $id используется функция is_numeric, которая возвращает True в случае, если $id – число, иначе – False. В случае успешной проверки параметр $id будет передаваться в запрос, иначе – запрос будет статичным и независимым от $id.

![Измененная функция actionView с проверкой типа параметра $id](image/25.png){#fig-021 width=70%}


## Устранение последствия Web portal meterpreter

:::::::::::::: {.columns align=center}
::: {.column width="49%"}


Нарушитель установил shell сессию с веб-порталом PHP. Ранее мы проверили сокеты уязвимой машины (Web Server PHP) и нашли соединение с внешним подозрительным сервером: активное соединение веб-портала с IP-адресом нарушителя (195.239.174.11). Для устранения необходимо воспользоваться командой ssс правами привилегированного пользователя, используя ключ –K и соответствующий адрес, порт для завершения сессии с нарушителем: sudo ss -K dst HACKER_IP dport = HACKER_PORT.

:::
::: {.column width="49%"}

![Завершение сессии с нарушителем](image/26.png){#fig-022 width=90%}

:::
::::::::::::::

## Устранение уязвимости "Отключенная защита антивируса"

На узле Administrator Workstation мы удалили запись об отключенном антишпионском ПО в реестре через консоль, используя команду: `REG DELETE "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware`. Подтвердили действие, далее в Windows Defender перезапустили Virus & Threat Protection и включили Real-time Protection 

![Удаление записи DisableAntiSpyware в реестре](image/29.png){#fig-023 width=70%}


## Устранение уязвимости "Отключенная защита антивируса"


:::::::::::::: {.columns align=center}
::: {.column width="45%"}

![Интерфейс Windows Defender](image/30.png){#fig-024 width=70%}

:::
::: {.column width="45%"}

![Включение Real-time Protection](image/31.png){#fig-025 width=70%}


:::
::::::::::::::

## Устранения последствия "Admin meterpreter"

:::::::::::::: {.columns align=center}
::: {.column width="49%"}

![Соединение с машиной нарушителя](image/27.png){#fig-026 width=70%}

:::
::: {.column width="49%"}

Установленную сессию с нарушителем ранее обнаружили при помощи утилиты netstat с ключами –ano.

:::
::::::::::::::

## Устранения последствия "Admin meterpreter"


Для устранения завершили сессию с машиной нарушителя при помощи команды taskkill /f /pid <PID>.

![Остановка процесса](image/28.png){#fig-027 width=70%}


## Устранение уязвимости "Слабый пароль учетной записи"

Изменяем пароль к учетной записи администратора на более сложный, не содержащийся в словарях, на узле MS Active Directory.

На нижеупомянутом рисунке изображена смена пароля администратора на узле MS Active Directory командой «net user Administrator *». В результате изменения ненадежного пароля уязвимость успешно устранена.

![Изменение пароля администратора](image/33.png){#fig-028 width=70%}

## Обнаружение и устранение последствия "AD User"

:::::::::::::: {.columns align=center}
::: {.column width="49%"}

Для удаления пользователя зашли в Administrative Tools – Active Directory Users and computers. Затем во вкладке Users найшли и удалилинового привилегированного пользователя с именем «Hacked».

:::
::: {.column width="49%"}

![Удаление пользователя hacker в AD User & Computers](image/34.png){#fig-029 width=70%}

:::
::::::::::::::

## Выводы

В ходе выполнения лабораторной работы были успешно достигнуты поставленные цели: освоены практические навыки выявления, анализа и устранения типовых уязвимостей информационной системы. В рамках сценария «Защита контроллера домена предприятия» были обнаружены и закрыты критические уязвимости и их последствия эксплуатации.


:::::::::::::: {.columns align=center}
::: {.column width="45%"}

![Выполненные карточки](image/22.png){#fig-030 width=70%}

:::
::: {.column width="45%"}

![Закрытые уязвимости и последствия](image/23.png){#fig-031 width=70%}

:::
::::::::::::::

## 

Спасибо за внимание!
